<!DOCTYPE html>
<html style="height: 100%">

<head>
    <meta charset="utf-8">
</head>

<body style="height: 100%; margin: 0">
    <div id="container" style="height: 100%"></div>
    <script type="text/javascript" src="scripts/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="scripts/echarts.js"></script>
    <script type="text/javascript">
        var dom = document.getElementById("container");
        var chart = echarts.init(dom);
        var app = {};
        chart.showLoading();

        function get_coordinate(node, categories, nodes_count)
        {
            console.log(categories.length);
            console.log(nodes_count);
            x = 1.0;
            y = 2.0;

            return new array(x, y);
        }

        var render = $.get('data/jam-people-chatbot.json', function (dataset) {
            chart.hideLoading();

            // 设置阈值
            THRESHOLD_EDGE = 1 // low:1, middle:3, high:15
            THRESHOLD_NODE = 0
            THRESHOLD_DEGREE = 1
            THRESHOLD_SHOW_LABEL = 80 // 2 sigma: 66, 3 sigma: 49
            THRESHOLD_GROUP_BY_FIELD = 'boardarea'

            // 设置分类
            var categories = [];
            //var categories_colors = ["#999999", "#A7A250", "#6D9881", "#E6AC3B"];
            var array_cate = dataset.nodes.map(function (node) {
                return node[THRESHOLD_GROUP_BY_FIELD];
            });
            Array.prototype.distinct = function () {
                var res = [];
                var json = {};
                for (var i = 0; i < this.length; i++) {
                    if (!json[this[i]]) {
                        res.push(this[i]);
                        json[this[i]] = 1;
                    }
                }
                return res;
            };
            var array_cate_dist = array_cate.distinct();
            array_cate_dist.forEach(function (c, i) {
                categories.push({
                    "name": c,
                    // "itemStyle": {
                    //     "color": categories_colors[i]
                    // }
                });
            });
            console.log(categories);

            // 设置筛选节点(node)
            var nodes = []
            dataset.nodes.forEach(function (node) {
                if ((node.value >= THRESHOLD_NODE) && (node.networkdegree >= THRESHOLD_DEGREE)) {
                    nodes.push(node);
                }
            });

            alert(get_coordinate(nodes[0],categories, nodes.length));

            nodes.forEach(function (node) {
                node.category = node[THRESHOLD_GROUP_BY_FIELD];
                node.x = (Math.random() * 1600 - 800).toFixed(0)
                node.y = (Math.random() * 900 - 450).toFixed(0)
                node.symbolSize = node.value / 5 + 2;
                node.label = {
                    normal: {
                        show: node.value >= THRESHOLD_SHOW_LABEL
                    }
                };
            });

            // 设置筛选边(edge)
            var links = []
            dataset.links.forEach(function (edge) {
                if (edge.weight >= THRESHOLD_EDGE) {
                    links.push(edge);
                }
            });


            var option = {
                legend: [{
                    // selectedMode: 'single',
                    data: categories.map(function (c) {
                        return c.name;
                    })
                }],
                tooltip: {},
                visualMap: [{
                    // show: false,
                    type: 'continuous',
                    seriesIndex: 0,
                    text: ['nodes'],
                    textStyle: {
                        color: '#333'
                    },
                    calculable: true,
                    max: 100,
                    inRange: {
                        //color: ['#87aa66', '#eba438', '#d94d4c']
                    }
                }],
                series: [{
                    type: 'graph',
                    layout: 'force',
                    force: {
                        initLayout: 'circular',
                        edgeLength: 8, // 边的两个节点之间的距离，这个距离也会受 repulsion。支持设置成数组表达边长的范围，此时不同大小的值会线性映射到不同的长度。值越小则长度越长。
                        repulsion: 40, // 支持设置成数组表达斥力的范围，此时不同大小的值会线性映射到不同的斥力。值越大则斥力越大。default: 50
                        gravity: 0.2 // 节点受到的向中心的引力因子。该值越大节点越往中心点靠拢。default: 0.1
                    },
                    circular: {
                        rotateLabel: true
                    },
                    draggable: true, // 节点是否可拖拽，只在使用力引导布局的时候有用
                    animation: true,
                    roam: false, // 是否开启鼠标缩放和平移漫游。默认不开启。如果只想要开启缩放或者平移，可以设置成 'scale' 或者 'move'。设置成 true 为都开启
                    label: {
                        normal: {
                            position: 'right',
                            formatter: function (param) {
                                return param.name;
                            }
                        }
                    },
                    focusNodeAdjacency: true, // 节点hover时显示连接节点与边
                    categories: categories,
                    data: nodes,
                    edges: links,
                    lineStyle: {
                        color: 'source',
                        curveness: 0.2,
                        opacity: 0.6,
                        width: 0.5
                    },
                    /*                     emphasis: {
                                            lineStyle: {
                                                width: 2,
                                                opacity: 0.8
                                            }
                                        } */
                    tooltip: {
                        formatter: function (param) {
                            if (param.dataType == 'edge') {
                                return param.name;
                            } else if (param.dataType == 'node') {
                                return [
                                    param.name + ': ' + param.value.toFixed(2),
                                    '<hr size="1"  style="margin: 3px 0" />',
                                    '<ul>',
                                    '<li>id: ' + param.data.username + '</li>',
                                    '<li>' + param.data.boardarea + '</li>',
                                    '</ul>'
                                ].join('');
                            }
                        }
                    }
                }]
            };

            if (option && typeof option === "object") {
                chart.setOption(option, true);
            }

            chart.on('click', function (param) {
                //window.open('https://www.baidu.com/s?wd=' + encodeURIComponent(params.username));
                if (param.data.profile != undefined) {
                    window.open(param.data.profile);
                }
            });
        });
    </script>
</body>

</html>